"use strict";function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};!function(){function a(a,b){for(var c="",d=1;d<=b-(a+"").length;d++)c+="0";return c+a}function b(a){return(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function c(b){return a(parseInt(b/6e4),2)+":"+a(parseInt(b/1e3%60),2)}function d(a,b){var c=document.createElement("link");c.setAttribute("id",a),c.setAttribute("type","text/css"),c.setAttribute("rel","stylesheet"),c.setAttribute("href",chrome.extension.getURL(b)),document.head?document.head.appendChild(c):document.documentElement.appendChild(c)}function e(){chrome.runtime.sendMessage({command:"getAd"},function(a){"on"===a.value&&d("bilibiliHelperAdStyle","bilibiliHelperAd.min.css")})}function f(){d("bilibiliHelperVideo","bilibiliHelperVideo.min.css"),$("#bilibili_helper .t .icon").css("background-image","url("+chrome.extension.getURL("imgs/helper-neko.png")+")")}function g(a){var b=$("#bilibiliPlayer"),c=function(){if("wide"!==a||b.hasClass("mode-widescreen")){if("webfullscreen"===a&&!b.hasClass("mode-webfullscreen")){var c=$(".bilibili-player-iconfont-web-fullscreen");0===c.length||c.length>0&&c.click()}}else{var d=$(".bilibili-player-iconfont-widescreen");if(0===d.length){var e=$("#player_placeholder").find("param[name=flashvars]");e.val(e.val()+"&as_wide=1"),$("#player_placeholder").attr("data",$("#player_placeholder").attr("data"))}else d.click()}};if($("#player_placeholder > *").length>0)c();else{var d=new MutationObserver(function(){c(),d.disconnect()});$("#bofqi").length>0?d.observe($("#bofqi")[0],{childList:!0}):$("#bilibiliPlayer").length>0&&d.observe($("#bilibiliPlayer")[0],{childList:!0})}}function h(){"scrollRestoration"in history&&(history.scrollRestoration="manual",$(document).scrollTop($(".player-wrapper").offset().top))}function i(a,b,c,d,e){var f="av"+a+"_",g=c&&c>1?"p"+b+"_":"",h="",i=e&&e>1?""+d+"_":"";return g&&(h=$(".player-wrapper #plist > span").text(),h=h.substr(h.indexOf("、")+1)+"_"),f+g+h+i+$("div.v-title").text().trim()}function j(a,b){var c=null,d=a.split("://").pop().split("?")[0],e=d.match(/[.]/)?d.match(/[^.]+$/):"mp4";switch(e){case"letv":e="flv"}return c=filenameSanitize(b,{replacement:"_",max:255-e.length-1})+"."+e,{url:a,filename:c}}var k=function(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.onload=function(){b({text:function(){return d.responseText}})},d.onerror=d.ontimeout=function(){c(new TypeError("Network request failed"))},d.open("get",a,!0),d.send()})};if($("html").hasClass("bilibili-helper"))return!1;if(!store.enabled)return!1;store["delete"]=function(a,b){if(void 0!==a){var c=store.get(a);void 0!==c&&(void 0!==b&&null!==b?"string"!=typeof b&&"number"!=typeof b||(c[b]&&delete c[b],store.set(a,c)):store.remove(a))}};var l={112:"1080P",80:"超清",64:"高清",32:"清晰",16:"流畅"},m={};if(m.eval=function(a){var b=Function;return new b("return "+a)()},m.handlePlayUrl=function(a){a.accept_quality.length>m.playQualities&&(m.playQualities=a.accept_quality),m.playUrls[a.quality]=a.durl,m.domReady&&m.renderDownloadSection()},m.renderDownloadSection=function(){m.mainBlock.downloaderSection.find("p").empty(),m.mainBlock.downloaderSection.find("p").append($("<h4>清晰度</h4>")),(!m.selectedQuality||m.playQualities.indexOf(m.selectedQuality)<-1)&&(m.selectedQuality=Math.max.apply(Math,_toConsumableArray(Object.keys(m.playUrls))));for(var a=0;a<m.playQualities.length;a++){var b=$('<a class="b-btn" rel="noreferrer"></a>').text(m.playQualities[a]?l[m.playQualities[a]]:m.playQualities[a]).data("quality",m.playQualities[a]);m.playQualities[a]!==m.selectedQuality&&b.addClass("w"),m.playUrls[m.playQualities[a]]||(b.addClass("disabled"),b.text(b.text()+" (未获取)")),b.click(function(){return!!$(this).hasClass("w")&&($(this).hasClass("disabled")?(window.alert("请切换播放器画质以获取"+l[$(this).data("quality")]+"下载地址."),!1):(m.selectedQuality=$(this).data("quality"),void m.renderDownloadSection()))}),m.mainBlock.downloaderSection.find("p").append(b)}m.mainBlock.downloaderSection.find("p").append($("<h4>下载分段</h4>"));for(var d=m.playUrls[m.selectedQuality],e=0;e<d.length;e++){var f=d[e];if("object"===("undefined"==typeof f?"undefined":_typeof(f))){var g=j(f.url,i(m.avid,m.page,m.totalPage,e,d.length)),h=$('<a class="b-btn w" referrerpolicy="unsafe-url"></a>').text("分段 "+(parseInt(e)+1)).data("download",g.filename).attr("title",isNaN(parseInt(f.filesize/1048576+.5))?"长度: "+c(f.length):"长度: "+c(f.length)+" 大小: "+parseInt(f.filesize/1048576+.5)+" MB").attr("href","//"+f.url.split("://")[1]);m.mainBlock.downloaderSection.find("p").append(h),h.click(function(a){chrome.runtime.sendMessage({command:"suggestName",url:m.protocol+$(a.target).attr("href"),filename:$(a.target).data("download")})})}}},0===document.location.pathname.indexOf("/blackboard/"))m.site=2;else if("bangumi.bilibili.com"===location.hostname)m.site=1;else if(0===document.location.pathname.indexOf("/bangumi/"))m.site=3;else{if("www.bilibili.com"!==location.hostname)return!1;m.site=0}if(m.protocol=location.protocol,e(),2!==m.site){chrome.runtime.onMessage.addListener(function(a,b,c){switch(a.command){case"update":return e(),c({result:"ok"}),!0;case"error":return!0;case"playurl":return Object.keys(a.data).length>0&&m.handlePlayUrl(a.data),!0;default:return c({result:"unknown"}),!1}});var n=function(){m.playUrls.length&&m.renderDownloadSection(),m.domReady=!0},o=function(){m.playUrls={},m.playQualities=[],m.videoPic=$("img.cover_image").attr("src"),m.totalPage=$("#dedepagetitles option").length,$(".v1-bangumi-info-operate .helper").remove(),"undefined"==typeof m.page?m.page=1:m.page=parseInt(m.page),m.pageOffset=0,chrome.runtime.sendMessage({command:"init"},function(a){if(m.version=a.version,m.autowide=a.autowide,m.autooffset=a.autooffset,m.originalPlayer=localStorage.getItem("bilimac_original_player")||$("#bofqi").html(),localStorage.removeItem("bilimac_original_player"),m.switcher={current:"original",set:function(a){m.mainBlock.switcherSection&&(m.mainBlock.switcherSection.find('a.b-btn[type="'+this.current+'"]').addClass("w"),m.mainBlock.switcherSection.find('a.b-btn[type="'+a+'"]').removeClass("w")),this.current=a},original:function(){this.set("original"),$("#bofqi").html(m.originalPlayer)},bilimac:function(){this.set("bilimac"),$("#bofqi").html('<div id="player_placeholder" class="player"></div><div id="loading-notice">正在加载 Bilibili Mac 客户端…</div>'),$("#bofqi").find("#player_placeholder").css({background:"url("+m.videoPic+") 50% 50% / cover no-repeat","-webkit-filter":"blur(20px)",overflow:"hidden",visibility:"visible"}),chrome.runtime.sendMessage({command:"callBilibiliMac",data:{action:"playVideoByCID",data:m.cid+"|"+window.location.href+"|"+document.title+"|"+(2===m.cidHack?2:1)}},function(a){a?$("#bofqi").find("#loading-notice").text("已在 Bilibili Mac 客户端中加载"):$("#bofqi").find("#loading-notice").text("调用 Bilibili Mac 客户端失败 :(")})}},m.helperBlock&&m.helperBlock.remove(),0===m.site)m.helperBlock=$('<div class="block bili-helper" id="bilibili_helper"><span class="t"><div class="icon"></div><div class="t-right"><span class="t-right-top middle">助手</span><span class="t-right-bottom">扩展菜单</span></div></span><div class="info"><div class="main"></div><div class="version" title="'+m.version+'">哔哩哔哩助手 by <a href="http://weibo.com/guguke" target="_blank">@啾咕咕</a> <a href="http://weibo.com/ruo0037" target="_blank">@肉肉</a><a class="setting b-btn w" href="'+chrome.extension.getURL("options.html")+'" target="_blank">设置</a></div></div></div>'),m.helperBlock.find(".t").click(function(){m.helperBlock.toggleClass("active")});else if(1===m.site)m.helperBlock=$('<span class="bili-helper"><div class="v1-bangumi-info-btn" id="bilibili_helper">哔哩哔哩助手</div><div class="info"><div class="main"></div><div class="version" title="'+m.version+'">哔哩哔哩助手 by <a href="http://weibo.com/guguke" target="_blank">@啾咕咕</a> <a href="http://weibo.com/ruo0037" target="_blank">@肉肉</a><a class="setting b-btn w" href="'+chrome.extension.getURL("options.html")+'" target="_blank">设置</a></div></div></span>'),m.helperBlock.find(".v1-bangumi-info-btn").click(function(){m.helperBlock.toggleClass("active")});else if(3===m.site){m.helperBlock=$('<span class="bili-helper"><li class="share-btn btn-bilihelper" id="bilibili_helper">哔哩哔哩助手</li><div class="info"><div class="main"></div><div class="version" title="'+m.version+'">哔哩哔哩助手 by <a href="http://weibo.com/guguke" target="_blank">@啾咕咕</a> <a href="http://weibo.com/ruo0037" target="_blank">@肉肉</a><a class="setting b-btn w" href="'+chrome.extension.getURL("options.html")+'" target="_blank">设置</a></div></div></span>'),m.helperBlock.find(".btn-bilihelper").click(function(){m.helperBlock.toggleClass("active")});var b=document.createElement("link");b.setAttribute("type","text/css"),b.setAttribute("rel","stylesheet"),b.setAttribute("href","//static.hdslb.com/css/core-v5/page-core.css"),document.head.appendChild(b)}var c=m.helperBlock.find(".info");m.mainBlock=c.find(".main"),m.mainBlock.infoSection=$('<div class="section video hidden"><h3>视频信息</h3><p><span></span><span>aid: '+m.avid+"</span><span>pg: "+m.page+"</span></p></div>"),m.mainBlock.append(m.mainBlock.infoSection),m.mainBlock.dblclick(function(a){a.shiftKey&&m.mainBlock.infoSection.toggleClass("hidden")}),localStorage.getItem("bilimac_player_type")&&(m.mainBlock.switcherSection=$('<div class="section switcher"><h3>播放器切换</h3><p></p></div>'),m.mainBlock.switcherSection.find("p").append($('<a class="b-btn w" type="original">原始播放器</a><a class="b-btn w" type="bilimac">Mac 客户端</a>').click(function(){m.switcher[$(this).attr("type")]()})),m.mainBlock.append(m.mainBlock.switcherSection)),m.mainBlock.downloaderSection=$('<div class="section downloder"><h3>视频下载</h3><p><span></span>视频地址获取中，请稍等…</p></div>'),m.mainBlock.append(m.mainBlock.downloaderSection),m.mainBlock.querySection=$('<div class="section query"><h3>弹幕发送者查询</h3><p><span></span>正在加载全部弹幕, 请稍等…</p></div>'),m.mainBlock.append(m.mainBlock.querySection),m.switcher.set("original"),"off"!==a.autowide&&g(a.autowide),0===m.site?$(".player-wrapper .arc-toolbar").append(m.helperBlock):1===m.site?$(".v1-bangumi-info-operate .v1-app-btn").after(m.helperBlock):3===m.site&&$(".bangumi-info .func-module .btn-app").after(m.helperBlock),$(document).ready(v),f()})};if("function"==typeof $&&$(".player-wrapper .v-plist").length){var p=document.createElement("script");p.id="page-prob",p.innerHTML="$('.player-wrapper .v-plist').attr('length', window.VideoPart.nodedata.length);$('#page-prob').remove();",document.body.appendChild(p)}$("html").addClass("bilibili-helper");var q=void 0,r=void 0,s=void 0;if(0===m.site)q=/\/video\/av([0-9]+)\/(?:index_([0-9]+)\.html)?.*?$/,r=q.exec(document.location.pathname),s=/page=([0-9]+)/.exec(document.location.hash),s&&"object"===("undefined"==typeof s?"undefined":_typeof(s))&&!isNaN(s[1])&&(s=parseInt(s[1])),r&&(m.avid=r[1],m.page=s||r[2]),m.avid&&o(),window.addEventListener("hashchange",function(){var a=/page=([0-9]+)/.exec(document.location.hash);a&&"object"===("undefined"==typeof a?"undefined":_typeof(a))&&!isNaN(a[1])&&(a=parseInt(a[1])),a&&a!==m.page&&o()},!1);else if(1===m.site||3===m.site){var t=$("#bofqi")[0];if(t){var u=new MutationObserver(function(){if(($("iframe.player").length||$('.scontent object param[name="flashvars"]').length)&&(r=$('.scontent object param[name="flashvars"]').attr("value")||$("iframe.player").attr("src"))){var a=r.split("&").map(function(a){return a.split("=",2)});a.forEach(function(a){var b=a[0],c=a[1];"aid"===b?m.avid=c:"cid"===b?m.cid=c:"seasonId"===b?m.seasonId=c:"episodeId"===b&&(m.episodeId===c?m.sameVideo=!0:m.sameVideo=!1,m.episodeId=c)}),m.sameVideo===!1&&o()}});u.observe(t,{childList:!0})}}else 2===m.site&&chrome.runtime.sendMessage({command:"init"},function(a){"off"!==a.autowide&&g(a.autowide)});m.work=function(){chrome.runtime.sendMessage({command:"getVideoInfo",avid:m.avid,pg:m.page+m.pageOffset},function(a){function d(){m.mainBlock.infoSection.find("p").append($("<span>cid: "+m.cid+"</span>"));var a=$('<div class="section comment"><h3>弹幕下载</h3><p><a class="b-btn w" href="'+m.protocol+"//comment.bilibili.com/"+m.cid+'.xml">下载 XML 格式弹幕</a></p></div>'),d=m.protocol+"//comment.bilibili.com/"+m.cid+".xml",e=i(m.avid,m.page,m.totalPage,1,1),f=j(d,e).filename;a.find("a").attr("download",f).click(function(a){a.preventDefault(),m.xml_str?chrome.runtime.sendMessage({command:"requestForDownload",data:m.xml_str,filename:$(a.target).attr("download")}):chrome.runtime.sendMessage({command:"requestForDownload",url:$(a.target).attr("href"),filename:$(a.target).attr("download")})}),m.mainBlock.commentSection=a,m.mainBlock.append(m.mainBlock.commentSection),k(m.protocol+"//comment.bilibili.com/"+m.cid+".xml").then(function(a){return a.text()}).then(function(a){m.xml_str=a;var d=new DOMParser,e=d.parseFromString(a.replace(/(?:[\0-\x08\x0B\f\x0E-\x1F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])/g,""),"text/xml"),g="\ufeff"+generateASS(setPosition(parseXML("",e)),{title:i(m.avid,m.page,m.totalPage,1,1),ori:location.href}),h=new Blob([g],{type:"application/octet-stream"}),j=window.URL.createObjectURL(h),k=$('<a class="b-btn w">下载 ASS 格式弹幕</a>').attr("download",f.replace(".xml",".ass")).attr("href",j).data("data",g).click(function(a){a.preventDefault(),chrome.runtime.sendMessage({command:"requestForDownload",data:$(a.target).data("data"),url:$(a.target).attr("href"),filename:$(a.target).attr("download")})});m.mainBlock.commentSection.find("p").append(k),m.comments=e.getElementsByTagName("d");var l=$('<div><input type="text" class="b-input" placeholder="根据关键词筛选弹幕"><div class="b-slt"><span class="txt">请选择需要查询的弹幕…</span><div class="b-slt-arrow"></div><ul class="list"><li disabled="disabled" class="disabled" selected="selected">请选择需要查询的弹幕</li></ul></div><span></span><span class="result">选择弹幕查看发送者…</span></div>');l.find(".b-input").keyup(function(){var a=l.find("input").val(),d=new RegExp(b(a),"gi");l.find("ul.list").html('<li disabled="disabled" class="disabled" selected="selected">请选择需要查询的弹幕</li>'),"请选择需要查询的弹幕"!==l.find(".b-slt .txt").text()&&""!==a.trim()&&l.find(".b-slt .txt").html(b(l.find(".b-slt .txt").text())),""!==a.trim()&&l.find(".b-slt .txt").text(l.find(".b-slt .txt").text());for(var e=l.find("ul.list"),f=0;f<m.comments.length;f++){var g=m.comments[f],h=g.childNodes[0];if(h&&g&&d.test(h.nodeValue)){h=h.nodeValue;var i=$("<li></li>"),j=g.getAttribute("p").split(","),k=void 0,n=void 0,o=void 0;void 0===m.comments[f].senderUsername?(k=j[6],m.comments[f].senderUsername=k):k=m.comments[f].senderUsername,void 0===m.comments[f].time?(n=c(1e3*parseInt(j[0])),m.comments[f].time=n):n=m.comments[f].time,void 0===m.comments[f].originalContent?(o=b(h),m.comments[f].originalContent=o):o=m.comments[f].originalContent;var p="["+n+"] ";i.attr({sender:k,index:f}),p+=""===a.trim()?o:o.replace(d,function(a){return'<span class="kw">'+a+"</span>"}),i.append(p).attr("title",o),g.error===!0&&i.addClass("error"),e.append(i)}}var q=document.createElement("script");q.appendChild(document.createTextNode('UserCard.bind($("#bilibili_helper .query .list .result"));')),document.body.appendChild(q),q.parentNode.removeChild(q),l.find(".b-slt .list li").on("click",function(a){$(".b-slt .list").hide(),m.selectedDanmu&&m.selectedDanmu.removeClass("selected");var c=$(a.target);m.selectedDanmu=c,m.selectedDanmu.addClass("selected");var d=c.attr("sender"),e=c.attr("index");if(l.find(".result").text("查询中…"),0===d.indexOf("D"))return void l.find(".result").text("游客弹幕");var f=function(a,c){m.comments[e].senderId=a,m.comments[e].senderUsername=b(c.name),l.find('.result span a[data-usercard-mid="'+a+'"]').text(c.name).after('<div target="_blank" class="user-info-level l'+b(c.level_info.current_level)+'"></div>');var d=document.createElement("script");d.appendChild(document.createTextNode('UserCard.bind($("#bilibili_helper .query .result"));')),document.body.appendChild(d),d.parentNode.removeChild(d)},g=function(a){l.find(".result").html("发送者: <span></span>");var b=!0,c=!1,d=void 0;try{for(var e,g=function(){var a=e.value;l.find(".result span").append('<a href="'+m.protocol+"//space.bilibili.com/"+a+'" target="_blank" data-usercard-mid="'+a+'">UID: '+a+"</a><br/>");var b=sessionStorage.getItem("user/"+a);b?f(a,JSON.parse(b)):$.getJSON(m.protocol+"//api.bilibili.com/cardrich?mid="+a+"&type=json",function(b){if(0===b.code){var c=b.data.card;sessionStorage.setItem("user/"+a,JSON.stringify({name:c.name,level_info:{current_level:c.level_info.current_level}})),f(a,c)}else b.code===-626&&l.find('.result span a[data-usercard-mid="'+a+'"],.result span a[data-usercard-mid="'+a+'"]+br').remove()})},h=a[Symbol.iterator]();!(b=(e=h.next()).done);b=!0)g()}catch(i){c=!0,d=i}finally{try{!b&&h["return"]&&h["return"]()}finally{if(c)throw d}}},h=/^b(\d+)$/.exec(d);h?g(h[1]):chrome.runtime.sendMessage({command:"uidLookup",user:d},function(a){a.uids.length<0?(l.find(".result").text("查询失败."),c.addClass("error"),m.comments[e].error=!0):g(a.uids)})})}),l.find(".b-input").keyup(),l.find(".b-slt").on("mouseover",function(){$(".b-slt .list").show()}).on("mouseleave",function(){$(".b-slt .list").hide()}),m.mainBlock.querySection.find("p").empty().append(l)})}var e=a.videoInfo;if("number"==typeof e.cid&&0===$(".b-page-body .viewbox").length&&0===$(".main-inner .viewbox").length&&(m.genPage=!0,m.copyright=!0),m.videoPic=e.pic,"number"==typeof m.totalPage&&m.totalPage>e.pages&&m.pageOffset>e.pages-m.totalPage)return m.pageOffset=e.pages-m.totalPage,m.work(),!1;"off"!==m.autowide&&g(m.autowide),"on"===m.autooffset&&h(),"undefined"!=typeof e.code?1!==m.page?chrome.runtime.sendMessage({command:"getVideoInfo",avid:m.avid,pg:1,isBangumi:1===m.site},function(a){var b=a.videoInfo;if(b.pages===m.page-1)return m.pageOffset-=1,m.work(),!1}):(m.error="错误"+e.code+": "+e.error,m.mainBlock.errorSection=$('<div class="section error"><h3>Cid 获取失败</h3><p><span></span><span>'+b(m.error)+"</span></p></div>"),m.mainBlock.append(m.mainBlock.errorSection),$("#loading-notice").fadeOut(300)):(void 0===m.cid&&(m.cid=e.cid),1===m.site?chrome.runtime.sendMessage({command:"getBangumiInfo",episodeId:m.episodeId},function(a){m.avid=a.videoInfo.avid,m.cid=a.videoInfo.danmaku,m.index=a.videoInfo.index,d()}):d());var f=null;return window.postMessage?(f=function(a){"https://secure.bilibili.com"!==a.origin&&"https://ssl.bilibili.com"!==a.origin||"secJS:"!==a.data.substr(0,6)||m.eval(a.data.substr(6))},window.addEventListener?window.addEventListener("message",f,!1):window.attachEvent&&window.attachEvent("onmessage",f)):setInterval(function(){var a=window.__GetCookie("__secureJS");window.__SetCookie("__secureJS",""),m.eval(a)},1e3),m.cid?void n():(m.error="错误"+e.code+": "+e.error,m.mainBlock.errorSection=$('<div class="section error"><h3>Cid 获取失败</h3><p><span></span><span>'+b(m.error)+"</span></p></div>"),m.mainBlock.append(m.mainBlock.errorSection),!1)})};var v=function(){m.totalPage=$(".player-wrapper .v-plist").attr("length"),isNaN(m.totalPage)||(m.totalPage=parseInt(m.totalPage)),"force"===localStorage.getItem("bilimac_player_type")&&m.switcher.set("bilimac"),localStorage.removeItem("bilimac_player_type"),m.replacePlayer=!1,m.work()}}}(),function(){if("/video/bgm_calendar.html"===location.pathname)for(var a=$("#bangumi"),b=(new Date).getDay()-1,c=0;c<7&&a.children()[0].getAttribute("weekday")!==b;++c){var d=a.children()[0];a.children()[0].remove(),a.append(d)}}();